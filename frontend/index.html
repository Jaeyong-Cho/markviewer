<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>MarkViewer - Markdown Viewer</title>
    
    <!-- Prevent module loading issues -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; 
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; 
        connect-src 'self' http://localhost:3001;
        img-src 'self' data: blob:;
    ">
    
    <!-- External libraries from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>
    <!-- Use the official CDN with fallback -->
            
        <!-- Directory Selection Modal -->
        <div id="directory-modal" class="modal hidden">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Select Workspace Directory</h3>
                    <button id="modal-close" class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <p>Enter the path to your markdown workspace directory:</p>
                    <input type="text" id="directory-input" class="directory-input" placeholder="/path/to/your/markdown/files" autocomplete="off">
                    <div class="modal-hint">
                        <small>Example: /Users/username/Documents/markdown-files</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="directory-cancel" class="btn btn-secondary">Cancel</button>
                    <button id="directory-confirm" class="btn btn-primary">Select Directory</button>
                </div>
            </div>
        </div>

    <script>
        // Log when scripts start loading
        (function() {
            var script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js';
            script.onload = function() {
                console.log('highlight.js loaded from cdnjs');
                window.hljsLoaded = true;
            };
            script.onerror = function() {
                console.warn('CDN failed, loading local highlight.js');
                var fallback = document.createElement('script');
                fallback.src = 'libs/highlight.min.js';
                fallback.onload = function() {
                    console.log('highlight.js loaded from local fallback');
                    window.hljsLoaded = true;
                };
                fallback.onerror = function() {
                    console.error('All highlight.js sources failed');
                    window.hljsLoaded = false;
                };
                document.head.appendChild(fallback);
            };
            document.head.appendChild(script);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <!-- Library loading verification -->
    <script>
        window.libraryLoadStatus = {
            marked: false,
            hljs: false,
            mermaid: false
        };
        
        // Check library loading status
        function checkLibraryLoading() {
            window.libraryLoadStatus.marked = typeof marked !== 'undefined';
            window.libraryLoadStatus.hljs = typeof hljs !== 'undefined';
            window.libraryLoadStatus.mermaid = typeof mermaid !== 'undefined';
            
            const missing = Object.entries(window.libraryLoadStatus)
                .filter(([lib, loaded]) => !loaded)
                .map(([lib]) => lib);
                
            if (missing.length > 0) {
                console.warn('Some libraries failed to load:', missing);
                // Show user-friendly error message
                if (missing.includes('hljs')) {
                    console.warn('Syntax highlighting will be disabled. Code blocks will appear without highlighting.');
                }
                if (missing.includes('mermaid')) {
                    console.warn('Mermaid diagrams will not render. Diagram blocks will show as code.');
                }
                if (missing.includes('marked')) {
                    console.error('Critical: Markdown parsing library failed to load. Application may not function properly.');
                }
            } else {
                console.log('All external libraries loaded successfully');
                console.log('highlight.js version:', typeof hljs !== 'undefined' ? hljs.versionString : 'undefined');
            }
            
            return missing.length === 0;
        }
        
        // Wait for highlight.js to load asynchronously
        function waitForHighlightJS(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof hljs !== 'undefined') {
                    clearInterval(checkInterval);
                    console.log('highlight.js detected after', attempts * 100, 'ms');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('highlight.js failed to load after', attempts * 100, 'ms');
                    callback();
                }
            }, 100);
        }
        
        // Check on page load
        document.addEventListener('DOMContentLoaded', () => {
            waitForHighlightJS(() => {
                checkLibraryLoading();
            });
        });
    </script>
    
    <!-- GitHub style for highlight.js with local fallback -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" 
          onerror="this.onerror=null; this.href='libs/github.min.css';">
    
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="styles/main.css">
    
    <!-- Additional styles for components -->
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/content.css">
    <link rel="stylesheet" href="styles/search.css">
</head>
<body>
    <!-- Main application container -->
    <div id="app" class="app-container">
        
        <!-- Header section -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">MarkViewer</h1>
                <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle sidebar">
                    <span class="hamburger"></span>
                </button>
            </div>
            
            <div class="header-center">
                <div class="root-directory-selector">
                    <button id="select-root-btn" class="select-root-btn">
                        Select Workspace Directory
                    </button>
                    <span id="current-root" class="current-root-path">No directory selected</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="search-container">
                    <input type="text" 
                           id="search-input" 
                           class="search-input" 
                           placeholder="Search markdown files..."
                           autocomplete="off">
                    <button id="search-clear" class="search-clear" aria-label="Clear search">
                        ×
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content area -->
        <main class="app-main">
            
            <!-- Sidebar for navigation -->
            <aside id="sidebar" class="sidebar">
                <div class="sidebar-content">
                    <div class="directory-tree" id="directory-tree">
                        <div class="tree-placeholder">
                            <p>Select a workspace directory to browse markdown files</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar footer with status -->
                <div class="sidebar-footer">
                    <div id="file-count" class="file-count">0 files</div>
                </div>
            </aside>

            <!-- Content area -->
            <section class="content-area">
                
                <!-- Search results (hidden by default) -->
                <div id="search-results" class="search-results hidden">
                    <div class="search-results-header">
                        <h2>Search Results</h2>
                        <span id="search-query" class="search-query"></span>
                        <span id="search-count" class="search-count"></span>
                    </div>
                    <div id="search-results-list" class="search-results-list">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <!-- Main content display -->
                <div id="main-content" class="main-content">
                    <div class="content-header">
                        <nav class="breadcrumb" id="breadcrumb">
                            <!-- Breadcrumb navigation will be populated here -->
                        </nav>
                        <div class="file-info">
                            <span id="current-file" class="current-file-name">Welcome</span>
                            <span id="file-modified" class="file-modified"></span>
                        </div>
                    </div>
                    
                    <div class="content-body">
                        <article id="markdown-content" class="markdown-content">
                            <div class="welcome-content">
                                <h1>Welcome to MarkViewer</h1>
                                <p>A powerful markdown viewer with PlantUML, Mermaid, and search capabilities.</p>
                                
                                <h2>Features</h2>
                                <ul>
                                    <li>Render markdown with JavaScript</li>
                                    <li>PlantUML diagrams using local plantuml.jar (SVG format)</li>
                                    <li>Mermaid diagram rendering</li>
                                    <li>Recursive directory sidebar navigation</li>
                                    <li>Full-text search functionality</li>
                                    <li>GitHub-style code highlighting</li>
                                </ul>
                                
                                <h2>Getting Started</h2>
                                <ol>
                                    <li>Click "Select Workspace Directory" to choose your markdown folder</li>
                                    <li>Browse files using the sidebar navigation</li>
                                    <li>Use the search box to find content across all files</li>
                                    <li>View rendered markdown with diagrams and highlighted code</li>
                                </ol>
                                
                                <div class="feature-demo">
                                    <h3>Code Highlighting Example</h3>
                                    <pre><code class="language-javascript">
// Example JavaScript code with syntax highlighting
function renderMarkdown(content) {
    const renderer = new marked.Renderer();
    return marked.parse(content, { renderer });
}
                                    </code></pre>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>
                
                <!-- Table of Contents hover sidebar -->
                <div class="toc-hover-trigger"></div>
                <div id="toc-sidebar" class="toc-sidebar">
                    <!-- TOC content will be populated dynamically -->
                </div>
            </section>
        </main>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p class="loading-text">Loading...</p>
            </div>
        </div>

        <!-- Error notifications -->
        <div id="notification" class="notification hidden">
            <div class="notification-content">
                <span class="notification-message"></span>
                <button class="notification-close">&times;</button>
            </div>
        </div>
    </div>

    <!-- Application scripts - Load in dependency order with cache busting -->
    <script>
        // Enhanced script loading with error handling and proper dependency management
        const timestamp = new Date().getTime();
        let loadedScripts = 0;
        const totalScripts = 6;
        let allScriptsLoaded = false;
        
        const loadScript = (src) => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = `${src}?v=${timestamp}`;
                script.defer = false; // Load synchronously for better dependency management
                
                script.onload = () => {
                    loadedScripts++;
                    console.log(`✅ Loaded: ${src} (${loadedScripts}/${totalScripts})`);
                    resolve();
                };
                
                script.onerror = (error) => {
                    console.error(`❌ Failed to load: ${src}`, error);
                    reject(new Error(`Failed to load ${src}`));
                };
                
                document.head.appendChild(script);
            });
        };
        
        // Load scripts sequentially to ensure proper dependency order
        const scripts = [
            'js/utils.js',
            'js/api.js', 
            'js/renderer.js',
            'js/sidebar.js',
            'js/search.js',
            'js/app.js'
        ];
        
        // Load scripts one by one to ensure dependency order
        async function loadScriptsSequentially() {
            try {
                for (const script of scripts) {
                    await loadScript(script);
                    // Small delay to ensure script execution
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                console.log('🎉 All scripts loaded successfully');
                allScriptsLoaded = true;
                
                // Trigger dependency check after all scripts are loaded
                window.dispatchEvent(new CustomEvent('scriptsLoaded'));
            } catch (error) {
                console.error('💥 Script loading failed:', error);
                document.body.innerHTML = `
                    <div style="padding: 20px; color: red; font-family: monospace;">
                        <h2>Script Loading Error</h2>
                        <p>Failed to load application scripts: ${error.message}</p>
                        <p>Please refresh the page or check the console for details.</p>
                    </div>
                `;
            }
        }
        
        // Start loading scripts
        loadScriptsSequentially();
    </script>
    
    <!-- Initialize application after all scripts are loaded -->
    <script>
        let appInitialized = false;
        
        function initializeApp() {
            if (appInitialized) return;
            
            // Check if all dependencies are loaded
            const dependencies = {
                Utils: typeof Utils !== 'undefined',
                API: typeof API !== 'undefined', 
                MarkdownRenderer: typeof MarkdownRenderer !== 'undefined',
                Sidebar: typeof Sidebar !== 'undefined',
                SearchManager: typeof SearchManager !== 'undefined',
                MarkViewerApp: typeof MarkViewerApp !== 'undefined'
            };
            
            const missingDeps = Object.entries(dependencies)
                .filter(([name, loaded]) => !loaded)
                .map(([name]) => name);
            
            if (missingDeps.length === 0) {
                console.log('🚀 All dependencies loaded, starting MarkViewer...');
                console.log('Dependencies check:', dependencies);
                
                try {
                    window.app = new MarkViewerApp();
                    appInitialized = true;
                    console.log('✅ MarkViewer application initialized successfully');
                } catch (error) {
                    console.error('❌ Failed to initialize MarkViewer:', error);
                }
            } else {
                console.warn(`⏳ Missing dependencies: ${missingDeps.join(', ')}`);
                console.log('Current state:', dependencies);
                return false;
            }
            
            return true;
        }
        
        // Try to initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            // Wait for scripts to be loaded
            const maxAttempts = 100; // 10 seconds max
            let attempts = 0;
            
            const tryInitialize = () => {
                attempts++;
                
                if (initializeApp()) {
                    console.log(`✅ App initialized after ${attempts} attempts`);
                    return;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('❌ Failed to initialize app after maximum attempts');
                    console.error('This usually means some script files failed to load properly');
                    
                    // Show user-friendly error
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position: fixed; top: 20px; left: 20px; right: 20px; background: #ff6b6b; color: white; padding: 15px; border-radius: 5px; z-index: 9999;';
                    errorDiv.innerHTML = `
                        <strong>Application Failed to Start</strong><br>
                        Some JavaScript files may not have loaded properly. 
                        Please refresh the page or check your network connection.
                        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; cursor: pointer;">×</button>
                    `;
                    document.body.appendChild(errorDiv);
                    return;
                }
                
                setTimeout(tryInitialize, 100);
            };
            
            // Start trying to initialize
            setTimeout(tryInitialize, 100);
        });
        
        // Also listen for the custom scriptsLoaded event
        window.addEventListener('scriptsLoaded', function() {
            console.log('📦 Scripts loaded event received');
            setTimeout(initializeApp, 200); // Small delay to ensure script execution
        });
    </script>
</body>
</html>
